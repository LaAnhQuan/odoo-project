<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="mo_hr_monthly_attendance.MonthlyAttendanceGrid">
        <div class="o_monthly_attendance_grid" t-on-click="onClickOutside">
            
            <!-- Header controls -->
            <div class="o_grid_header">
                <div class="o_grid_title">
                    <h3>
                        <span>Bảng chấm công tháng </span>
                        <t t-esc="state.month"/>/<t t-esc="state.year"/>
                    </h3>
                </div>
                <div class="o_grid_controls">
                    <button class="btn btn-secondary" t-on-click="onBackToMonthlySheet">
                        <i class="fa fa-arrow-left"/> Quay lại bảng chính
                    </button>
                    <button class="btn btn-info" t-on-click="onImportExcel">
                        <i class="fa fa-upload"/> Import Excel
                    </button>
                    <button class="btn btn-success" t-on-click="onAddNewRow">
                        <i class="fa fa-plus"/> Thêm dòng
                    </button>
                    <button class="btn btn-primary" t-on-click="onSaveChanges" t-att-disabled="!state.hasChanges">
                        <i class="fa fa-save"/> Lưu
                    </button>
                </div>
            </div>

            <!-- Loading spinner -->
            <div t-if="state.loading" class="o_grid_loading">
                <i class="fa fa-spinner fa-spin fa-3x"/>
            </div>

            <!-- Grid table -->
            <div t-else="" class="o_grid_table_container">
                <table class="table table-bordered o_attendance_grid_table">
                    <thead>
                        <!-- Header row 1: Thứ -->
                        <tr class="o_grid_header_row">
                            <th class="o_grid_cell_header sticky-col" rowspan="2">STT</th>
                            <th class="o_grid_cell_header sticky-col" rowspan="2">MANS</th>
                            <th class="o_grid_cell_header sticky-col" rowspan="2">Họ và tên</th>
                            <th class="o_grid_cell_header" t-foreach="state.days" t-as="day" t-key="'weekday_' + day">
                                <t t-esc="getWeekday(day)"/>
                            </th>
                            <th class="o_grid_cell_header" rowspan="2">Công</th>
                            <th class="o_grid_cell_header" rowspan="2">Phép</th>
                            <th class="o_grid_cell_header" rowspan="2">Không lương</th>
                            <th class="o_grid_cell_header" rowspan="2">Thai sản</th>
                            <th class="o_grid_cell_header" rowspan="2">Lễ</th>
                            <th class="o_grid_cell_header" rowspan="2">Hiếu</th>
                            <th class="o_grid_cell_header" rowspan="2">Hỷ</th>
                            <th class="o_grid_cell_header" rowspan="2">Giờ làm thêm</th>
                            <th class="o_grid_cell_header" rowspan="2">Tổng công</th>
                        </tr>
                        <!-- Header row 2: Ngày -->
                        <tr class="o_grid_header_row">
                            <th t-foreach="state.days" t-as="day" t-key="'day_' + day"
                                t-att-class="'o_grid_cell_day' + (isWeekend(day) ? ' weekend' : '') + (isSaturday(day) ? ' saturday' : '')">
                                <t t-esc="day"/>
                                <!-- <t t-if="isSaturday(day)">
                                    <span class="badge badge-warning" style="font-size: 9px; margin-left: 2px;">0.5</span>
                                </t> -->
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr t-foreach="state.records" t-as="record" t-key="record.id" 
                            class="o_grid_row"
                            t-on-contextmenu="(ev) => this.onRowRightClick(ev, record)">
                            <!-- STT -->
                            <td class="o_grid_cell_number sticky-col">
                                <t t-esc="record_index + 1"/>
                            </td>
                            
                            <!-- MANS -->
                            <td class="o_grid_cell_mans sticky-col" t-on-dblclick="(ev) => this.onEditEmployee(ev, record)">
                                <t t-esc="record.mans"/>
                            </td>
                            
                            <!-- Tên nhân viên -->
                            <td class="o_grid_cell_name sticky-col" t-on-dblclick="(ev) => this.onEditEmployee(ev, record)">
                                <strong><t t-esc="record.employee_name"/></strong>
                            </td>
                            
                            <!-- Các ngày trong tháng -->
                            <td t-foreach="state.days" t-as="day" t-key="'cell_' + record.id + '_' + day"
                                t-att-class="'o_grid_cell o_grid_cell_editable ' + getCellClass(record, day) + (isWeekend(day) ? ' weekend' : '')"
                                t-on-click="(ev) => this.onCellClick(ev, record, day)">
                                <div class="o_grid_cell_content">
                                    <t t-esc="shouldShowCellValue(record, day) ? getCellValue(record, day) : ''"/>
                                    <i class="fa fa-pencil o_grid_cell_edit_icon"/>
                                </div>
                            </td>
                            
                            <!-- Công -->
                            <td class="o_grid_cell_total o_grid_cell_work">
                                <strong><t t-esc="record.worked_days ? record.worked_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Phép -->
                            <td class="o_grid_cell_total o_grid_cell_leave">
                                <strong><t t-esc="record.paid_leave_days ? record.paid_leave_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Không lương -->
                            <td class="o_grid_cell_total o_grid_cell_unpaid">
                                <strong><t t-esc="record.unpaid_leave_days ? record.unpaid_leave_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Thai sản -->
                            <td class="o_grid_cell_total o_grid_cell_maternity">
                                <strong><t t-esc="record.maternity_days ? record.maternity_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Lễ -->
                            <td class="o_grid_cell_total o_grid_cell_holiday">
                                <strong><t t-esc="record.holiday_days ? record.holiday_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Hiếu -->
                            <td class="o_grid_cell_total o_grid_cell_bereavement">
                                <strong><t t-esc="record.bereavement_days ? record.bereavement_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Hỷ -->
                            <td class="o_grid_cell_total o_grid_cell_wedding">
                                <strong><t t-esc="record.wedding_days ? record.wedding_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                            
                            <!-- Giờ làm thêm -->
                            <td class="o_grid_cell_total">
                                <t t-esc="record.overtime_hours ? record.overtime_hours.toFixed(1) : '0.0'"/>
                            </td>
                            
                            <!-- Tổng ngày công -->
                            <td class="o_grid_cell_total o_grid_cell_percentage">
                                <strong><t t-esc="record.total_paid_days ? record.total_paid_days.toFixed(1) : '0.0'"/></strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Empty state -->
                <div t-if="state.records.length === 0" class="o_grid_empty">
                    <p>Không có dữ liệu chấm công cho tháng này.</p>
                </div>
            </div>

            <!-- Dropdown menu for editing attendance codes -->
            <div t-if="state.showDropdown" 
                 t-att-class="'o_attendance_code_dropdown' + (state.dropdownPosition.openUpward ? ' o_dropdown_upward' : '')"
                 t-att-style="`top: ${state.dropdownPosition.top}px; left: ${state.dropdownPosition.left}px;`"
                 t-on-click.stop="">
                <div class="o_dropdown_header">
                    <strong>Chọn loại công</strong>
                </div>
                <div class="o_dropdown_content">
                    <div t-foreach="attendanceCodes" t-as="codeItem" t-key="codeItem.code"
                         class="o_dropdown_item"
                         t-att-style="`border-left: 4px solid ${codeItem.color};`"
                         t-on-click="() => this.onCodeSelect(codeItem.code)">
                        <span class="o_code_label">
                            <t t-if="codeItem.code" t-esc="codeItem.code"/>
                            <t t-else="">--</t>
                        </span>
                        <span class="o_code_name" t-esc="codeItem.label"/>
                    </div>
                </div>
            </div>

            <!-- Context menu -->
            <div t-if="state.showContextMenu" 
                 class="o_context_menu"
                 t-att-style="`top: ${state.contextMenuPosition.top}px; left: ${state.contextMenuPosition.left}px;`"
                 t-on-click.stop="">
                <div class="o_context_menu_item" t-on-click="onEditEmployeeFromMenu">
                    <i class="fa fa-edit"/> Sửa thông tin
                </div>
                <div class="o_context_menu_item o_context_menu_danger" t-on-click="onDeleteEmployee">
                    <i class="fa fa-trash"/> Xóa dòng
                </div>
            </div>

            <!-- Modal for editing employee info -->
            <div t-if="state.showEmployeeModal" class="o_employee_modal_backdrop" t-on-click="onCloseEmployeeModal">
                <div class="o_employee_modal" t-on-click.stop="">
                    <div class="o_modal_header">
                        <h4><t t-if="state.editingRecord and state.editingRecord.id > 0">Sửa thông tin nhân viên</t><t t-else="">Thêm nhân viên mới</t></h4>
                        <button class="btn btn-link" t-on-click="onCloseEmployeeModal">
                            <i class="fa fa-times"/>
                        </button>
                    </div>
                    <div class="o_modal_body">
                        <div class="form-group">
                            <label>MANS</label>
                            <input type="text" 
                                   class="form-control" 
                                   t-att-value="state.editingRecord ? state.editingRecord.mans : ''"
                                   t-on-input="(ev) => this.onModalInputChange(ev, 'mans')"/>
                        </div>
                        <div class="form-group">
                            <label>Họ và tên</label>
                            <input type="text" 
                                   class="form-control" 
                                   t-att-value="state.editingRecord ? state.editingRecord.employee_name : ''"
                                   t-on-input="(ev) => this.onModalInputChange(ev, 'employee_name')"/>
                        </div>
                    </div>
                    <div class="o_modal_footer">
                        <button class="btn btn-secondary" t-on-click="onCloseEmployeeModal">Hủy</button>
                        <button class="btn btn-primary" t-on-click="onSaveEmployeeModal">Lưu</button>
                    </div>
                </div>
            </div>
        </div>
    </t>

</templates>
